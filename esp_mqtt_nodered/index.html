<!doctype html>
<html lang="en">

<head>
        <title>ESP, MQTT, Node-RED - Cybersécurité, Informatique et Réseaux, Électronique - Thomas Edison</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        
        
        

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
            <link rel="stylesheet" href="../assets/css/darcula-highlight.min.css">

        <link rel="stylesheet" href="../assets/css/bootstrap.min.css">
        <link rel="stylesheet" href="../assets/css/dracula-ui.min.css">
        <link rel="stylesheet" href="../assets/css/mkdocs.min.css">

        
            <link  rel="icon" type="image/x-icon" href="../assets/img/favicon.ico">
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
                <script>hljs.initHighlightingOnLoad();</script>

</head>

<body class="drac-bg-black-secondary drac-text-grey-ternary drac-text drac-scrollbar-purple">

    <main class="d-flex">

        <!-- block sidebar -->
            <nav id="sidebar" class="sidebar drac-bg-black">
    <div class="custom-menu">
        <button type="button" id="sidebarCollapse" class="btn btn-primary">
            <i class="fa fa-bars"></i>
            <span class="sr-only">Menu</span>
        </button>
    </div>

    <div class="p-4">
        

        <div class="drac-text-center">
            
                <span class="drac-text drac-line-height drac-text-white">Cybersécurité, Informatique et Réseaux, Électronique - Thomas Edison</span>
            
        </div>

        <div class="drac-box flex-column">
            <ul class="dot-ul">
                <li><div class="dot-li drac-bg-cyan"></div></li>
                <li><div class="dot-li drac-bg-green"></div></li>
                <li><div class="dot-li drac-bg-orange"></div></li>
                <li><div class="dot-li drac-bg-pink"></div></li>
                <li><div class="dot-li drac-bg-purple"></div></li>
                <li><div class="dot-li drac-bg-red"></div></li>
                <li><div class="dot-li drac-bg-yellow"></div></li>
            </ul>
        </div>

        <hr class="drac-divider" />

        <!-- block menu -->
        <ul class="mb-5 drac-list drac-list-none">
            
            <li class="drac-box">
                <a href=".."
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Home
                </a>
            </li>
            <li class="drac-box">
                <a href="../tinkerCAD/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    TinkerCAD
                </a>
            </li>
            <li class="drac-box">
                <a href="../proxmox/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Proxmox
                </a>
            </li>
            <li class="drac-box">
                <a href="../linux/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Linux
                </a>
            </li>
            <li class="drac-box">
                <a href="../euro/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Section Euro
                </a>
            </li>
            <li class="drac-box">
                <a href="../adresseip/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Adresse IP
                </a>
            </li>
            <li class="drac-box">
                <a href="../infranetwork/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Infrastructure Réseau
                </a>
            </li>
            <li class="drac-box">
                <a href="../esp/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Carte ESP32/ESP8622
                </a>
            </li>
            <li class="drac-box">
                <a href="../arduino/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Carte Arduino
                </a>
            </li>
            <li class="drac-box">
                <a href="../ide-arduino/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    IDE Arduino
                </a>
            </li>
            <li class="drac-box">
                <a href="../micropython/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    IDE MicroPython
                </a>
            </li>
            <li class="drac-box">
                <a href="../micropython-webserver/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    ESP32 GPIO Python Webserver
                </a>
            </li>
            <li class="drac-box">
                <a href="../read_temp_dht11_python/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    ESP32 Lire DHT11 Python
                </a>
            </li>
            <li class="drac-box">
                <a href="../read_temp_dht11_c/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    ESP32 Lire DHT11 C++
                </a>
            </li>
            <li class="drac-box">
                <a href="./"
                    class=" active 
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    ESP, MQTT, Node-RED
                </a>
            </li>
            <li class="drac-box">
                <a href="../raspberrypi/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Raspberry Pi
                </a>
            </li>
            <li class="drac-box">
                <a href="../ipphone/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Téléphonie IP
                </a>
            </li>
            <li class="drac-box">
                <a href="../reseau/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Réseau
                </a>
            </li>
            <li class="drac-box">
                <a href="../cordonrj45/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Cordon RJ45
                </a>
            </li>
            <li class="drac-box">
                <a href="../esp32_server/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    ESP32 Server
                </a>
            </li>
        </ul>
        <!-- endblock -->
    </div>
</nav>
        <!-- endblock -->

        <nav class="divider drac-bg-purple-cyan"></nav>

        <div class="content">
            <!-- block header -->
                <header>
    <nav class="navbar navbar-expand-xl drac-bg-purple">
        <div class="container-fluid">
            
            <button class="navbar-toggler w-100 text-center" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsMenu"
                aria-controls="navbarsMenu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse flex-column ml-auto" id="navbarsMenu">
                <ul class="navbar-nav text-md-center">

                    <!-- block preview -->
                    <li class="nav-item">
                            
        <div class="container">
            <div class="row row-preview">
                <div class="col">
                    <a href="../read_temp_dht11_c/"
                        class="btn-preview drac-btn drac-btn-outline drac-text-white drac-text-cyan-green--hover">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </div>
                <div class="col">
                    <a href="../raspberrypi/"
                        class="btn-preview drac-btn drac-btn-outline drac-text-white drac-text-cyan-green--hover" style="padding-left: 3%;">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
                    </li>
                    <!--  endblock -->

                    <!-- block search -->
                    <li class="nav-item">
                    </li>
                    <!--  endblock -->

                    <!-- block source -->
                    <li class="nav-item">
                        
                    </li>
                    <!--  endblock -->

                </ul>
            </div>

        </div>
    </nav>
</header>
            <!-- endblock -->

            <!-- block content -->
                <section class="p-md-5 section-content">
    <article>
        <p><div><h1 id="chaine-iot-esp-mqtt-et-node-red">Chaîne IOT : ESP, MQTT et Node-Red</h1>
<p><img alt="" src="../img/esp_mqtt_nodered.png"></p>
<h2 id="presentation-du-systeme">Présentation du système</h2>
<p>Les modules terminaux de l'internet des objets sont généralement alimentés par batterie. Dans ce cas l'utilisation d'un nano-ordinateur est impossible, l'autonomie serait trop faible. (Un nano-ordinateur Raspberry Pi alimenté par 3 piles de 1,5v a une autonomie de 3h à 6h).<br>
L'utilisation d'un microcontrôleur à faible consommation est généralement la solution utilisée dans l'IOT embarqué.  </p>
<p>Nos serveurs seront installées dans un des serveurs Proxmox. </p>
<p>Nous allons avoir besoin :<br>
- 1 serveur Node-RED dans un LXC (LXC c'est une VM un peu spécial)<br>
- 1 serveur MQTT dans un LXC<br>
-  1 client MQTT une ESP32  </p>
<h2 id="etape-1-installation-du-serveur-mqtt-mosquitto">Etape 1 : Installation du serveur MQTT (Mosquitto)</h2>
<p>Se connecter à un serveur/noeud en SSH.<br>
Installer MQTT en lançant se script :   </p>
<pre><code>bash -c "$(wget -qLO - https://github.com/tteck/Proxmox/raw/main/ct/mqtt.sh)"  
</code></pre>
<p>En mode Advanced :  </p>
<ul>
<li>Distribution : Debian  </li>
<li>Version : 12  </li>
<li>Type : Unprivileged  </li>
<li>Root Password : edison  </li>
<li>Container ID : 900x  </li>
<li>Static IPv4 : 10.0.6.9x/8  </li>
<li>Disable IPv6  </li>
<li>DNS Server IP : 1.1.1.1  </li>
</ul>
<p>Une fois l'installation terminé :  </p>
<ul>
<li>Se connecter en SSH au serveur MQTT  </li>
<li>Exécuter la commande suivante pour créer un utilisateur "edison" avec un mot de passe "edison" :  </li>
</ul>
<pre><code> mosquitto_passwd -c /etc/mosquitto/passwd edison
</code></pre>
<h2 id="etape-2-preparer-le-client-esp32">Etape 2 : Préparer le client (ESP32)</h2>
<p>Réaliser le câblage suivant :  </p>
<ul>
<li>une LED sortie la broche 5  </li>
<li>le capteur de tempéraure sur la broche 17  </li>
</ul>
<p>Dans l'IDE Arduino installer la library (blibliothèque) :  </p>
<ul>
<li>Adafruit_MQTT de Adafruit  </li>
<li>DHT sensor library de Adafruit  </li>
</ul>
<pre><code>#include &lt;WiFi.h&gt;
#include "Adafruit_MQTT.h"
#include "Adafruit_MQTT_Client.h"
#include "DHT.h"
/************************* WiFi Access Point *********************************/
#define WLAN_SSID       "xxxxxxx"  //SSID Wifi
#define WLAN_PASS       "xxxxxx  //key Wifi
/************************* Adafruit.io Setup *********************************/
#define SERVER      "xxx.xxx.xxx.xxx" //Addresse IP server MQTT
// Using port 1883 for MQTT
#define SERVERPORT  1883 //en local 1883
// Account Configuration
#define USERNAME "edison"
#define KEY      "edison"
/************ Global State (you don't need to change this!) ******************/
// WiFiFlCient
WiFiClient client;
// Setup the MQTT client class by passing in the WiFi client and MQTT server and login details.
Adafruit_MQTT_Client mqtt(&amp;client, SERVER, SERVERPORT, USERNAME, KEY);
/****************************** Feeds ***************************************/
// Setup a feed called 'temp' for publishing.
Adafruit_MQTT_Publish temp = Adafruit_MQTT_Publish(&amp;mqtt, "esp/temp");
// Setup a feed called 'onoffbutton' for subscribing to changes.
Adafruit_MQTT_Subscribe onoffbutton = Adafruit_MQTT_Subscribe(&amp;mqtt, "esp/onoffbutton");
/****************************** Feeds ***************************************/
#define LED       5 //LED PIN
#define DHTPIN 17
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE); // constructeur pour déclarer notre capteur
/*************************** Sketch Code ************************************/

void setup() {
  Serial.begin(115200);
  delay(10);
  pinMode(LED, OUTPUT);
  dht.begin();

  Serial.println("Client MQTT Example");

  // Connect to WiFi access point.
  Serial.println(); Serial.println();
  Serial.print("Connecting to ");
  Serial.println(WLAN_SSID);
  WiFi.begin(WLAN_SSID, WLAN_PASS);
  delay(500);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500); Serial.print(".");
  }
  Serial.println(); Serial.println("WiFi connected");
  Serial.println("IP address: "); Serial.println(WiFi.localIP());

  // Setup MQTT subscription for onoff feed.
  mqtt.subscribe(&amp;onoffbutton);
}

uint32_t x=0;

void loop() {

  MQTT_connect();

////// Subscribe part ///////
  Adafruit_MQTT_Subscribe *subscription;
  while ((subscription = mqtt.readSubscription(5000))) {
    if (subscription == &amp;onoffbutton) {
      Serial.print("Got: ");
      String mes = (char *)onoffbutton.lastread;
      Serial.println(mes);

      if(mes == "on") digitalWrite(LED,HIGH);
      else  digitalWrite(LED,LOW);     
    }
  }

 // if()

////// Publish part ///////
  //x = random(0, 100); //valeur à envoyer
  x = dht.readTemperature();
  // Now we can publish stuff!
  Serial.print("Sending val ");
  Serial.println(x);
  temp.publish(x);
  delay(2000); // wait a couple seconds to avoid rate limit

}

// Function to connect and reconnect as necessary to the MQTT server.
void MQTT_connect() {
  int8_t ret;

  // Stop if already connected.
  if (mqtt.connected()) {
    return;
  }

  Serial.print("Connecting to MQTT... ");

  uint8_t retries = 3;
  while ((ret = mqtt.connect()) != 0) { // connect will return 0 for connected
       Serial.println(mqtt.connectErrorString(ret));
       Serial.println("Retrying MQTT connection in 5 seconds...");
       mqtt.disconnect();
       delay(5000);  // wait 5 seconds
       retries--;
       if (retries == 0) {
         // basically die and wait for WDT to reset me
         while (1);
       }
  }

  Serial.println("MQTT Connected!");
}
</code></pre>
<p>Copier le code<br>
Modifier :   </p>
<ul>
<li>le SSID wifi  </li>
<li>le mot de passe wifi  </li>
<li>l'adresse du serveur MQTT<br>
Compiler le code  si aucune erreur uploader le code dans la carte.  </li>
</ul>
<p>Dans le serial monitor, vous devez voir la connexion réussie au wifi puis les températures envoyées au serveur MQTT.  </p>
<p><img alt="" src="../img/esp_mqtt.png"></p>
<p>Depuis le serveur Mosquitto (MQTT) entrer la commande suivante pour observer les données arrivant sur le serveur :  </p>
<pre><code>mosquitto_sub -h localhost -t "esp/temp" -u edison -P edison
</code></pre>
<p>ctrl + c pour quitter ce mode d'écoute  </p>
<p>Depuis le serveur Mosquitto (MQTT) entrer la commande suivante pour publier une donnée que le client viendra lire :  </p>
<pre><code>mosquitto_pub -h localhost -t "esp/onoffbutton" -u edison -P edison -m "test la connection est OK"
</code></pre>
<p>Dans le serial monitor, vous devez voir la reception du message récupérer sur le serveur MQTT.<br>
<img alt="" src="../img/esp_pub_test.png"></p>
<h2 id="etape-3-installation-du-serveur-mqtt-mosquitto">Etape 3 : Installation du serveur MQTT (Mosquitto)</h2>
<p>Se connecter à un serveur/noeud en SSH.<br>
Installer RED-Node en lançant se script :   </p>
<pre><code>bash -c "$(wget -qLO - https://github.com/tteck/Proxmox/raw/main/ct/node-red.sh)"   
</code></pre>
<p>En mode Advanced :  </p>
<ul>
<li>Distribution : Debian  </li>
<li>Version : 12  </li>
<li>Type : Unprivileged  </li>
<li>Root Password : edison  </li>
<li>Container ID : 800x  </li>
<li>Static IPv4 : 10.0.6.8x/8  </li>
<li>Disable IPv6  </li>
<li>DNS Server IP : 1.1.1.1  </li>
</ul>
<p>Une fois l'installation terminée :  </p>
<ul>
<li>Se connecter en SSH au serveur Node-RED  </li>
<li>Exécuter la commande suivante pour installer la bibliothèque dashboard :  </li>
</ul>
<pre><code class="language-bash">cd ~/.node-red
npm i node-red-dashboard
</code></pre>
<ul>
<li>Se connecter sur l'interface web du serveur Node-RED (port 1880)  </li>
</ul>
<p>Ouvrir le dashboard<br>
Ajouter les élèments suivant :</p>
<ul>
<li>mqtt in  </li>
<li>mqtt out  </li>
<li>switch  </li>
<li>gauge  </li>
</ul>
<p>Relier mqtt out à gauge et switch à mqtt in.  </p>
<p>Double-cliquer sur les élèments pour les configurer :  </p>
<ul>
<li>
<p>mqtt in  </p>
<ul>
<li>Serveur : adresse du serveur mqtt</li>
<li>Protocole : MQTT V3.1 (hérité)</li>
<li>Sécurité : user et password créés à la configuration du serveur MQTT (edison // edison)</li>
<li>Sujet (Topic) : esp/temp</li>
</ul>
</li>
<li>
<p>mqtt out  </p>
<ul>
<li>Serveur : adresse du serveur mqtt</li>
<li>Protocole : MQTT V3.1 (hérité)</li>
<li>Sécurité : user et password créés à la configuration du serveur MQTT (edison // edison)</li>
<li>Sujet (Topic) : esp/onoffbutton</li>
</ul>
</li>
<li>
<p>gauge  </p>
<ul>
<li>Range : 0 - 50 (paramétrages esthétiques)</li>
</ul>
</li>
<li>
<p>switch  </p>
<ul>
<li>On Payload : on</li>
<li>Off Payload : off</li>
</ul>
</li>
</ul>
<p>Une fois configurer, cliquer sur Déployer, puis ouvrir UI :  </p>
<ul>
<li>la gauge doit afficher la température  </li>
<li>le switch doit allumer/eteindre la LED  </li>
</ul>
<iframe width="560" height="315" src="https://www.youtube.com/embed/e4XJ23vXz3o?si=mvzd1gwRgWrZAWcu" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

<iframe title="node red" width="560" height="315" src="https://youtu.be/e4XJ23vXz3o?si=26LG5SnZF4Y87HoK" frameborder="0" allowfullscreen="" sandbox="allow-same-origin allow-scripts allow-popups"></iframe>

<p>Sources :<br>
https://randomnerdtutorials.com/esp8266-and-node-red-with-mqtt/<br>
https://eduscol.education.fr/sti/ressources_pedagogiques/le-protocole-mqqt-et-linternet-des-objet-iot<br>
https://eduscol.education.fr/sti/sites/eduscol.education.fr.sti/files/ressources/pedagogiques/12119/12119-3-mise-oeuvre-du-mqtt-avec-esp8266.docx</p></div></p>
    </article>
</section>
            <!-- endblock -->

            <!-- block footer -->
                <footer>
    <div class="d-flex flex-sm-row justify-content-between py-2 border-top drac-text-black drac-bg-cyan-green">
        <a href="https://github.com/dracula/mkdocs" target="_blank" style="padding-left: 1%;"
            class="footer-text drac-anchor drac-text-black drac-text-purple--hover">
            Made with Dracula Theme for MkDocs
        </a>
    </div>
</footer>
            <!-- endblock -->
        </div>

    </main>

        <script>var base_url = '..';</script>
        <script src="../assets/js/jquery-3.3.1.slim.min.js"></script>
        <script src="../assets/js/bootstrap.bundle.min.js"></script>
        <script src="../assets/js/mkdocs.js"></script>

</body>

</html>